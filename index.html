<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RetroStudio Plugin Marketplace</title>
  <!-- Firebase SDK as Modules -->
  <script type="module">
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "your-api-key",
      authDomain: "your-project-id.firebaseapp.com",
      projectId: "your-project-id",
      storageBucket: "your-project-id.appspot.com",
      messagingSenderId: "your-sender-id",
      appId: "your-app-id"
    };

    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, signInWithCredential, OAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();
    const storage = getStorage();

    // OAuth provider URL for Discord login
    const discordAuthUrl = "https://discord.com/oauth2/authorize?client_id=1335621884259336303&response_type=code&redirect_uri=https%3A%2F%2F1boc.github.io%2Fcmdbar%2F&scope=identify+openid";

    // Redirect user to Discord for OAuth login
    document.getElementById('discord-login').addEventListener('click', () => {
      window.location.href = discordAuthUrl;
    });

    // Handle the OAuth redirect and exchange code for token
    window.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      
      if (code) {
        // You now have the authorization code
        console.log('Received code:', code);

        // Instead of OAuthProvider.credential, we use OAuthProvider for Discord login
        const provider = new OAuthProvider('discord.com');
        provider.addScope('identify');
        provider.addScope('email');
        
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          console.log('Authenticated user:', user);
          loadMarketplace();
        } catch (error) {
          console.error('Authentication error:', error);
        }
      }
    });

    // Load marketplace features based on user authentication
    function loadMarketplace() {
      const user = auth.currentUser;
      if (user) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('upload-section').style.display = 'block';
        document.getElementById('plugin-list-section').style.display = 'block';
        
        loadPlugins();
        checkIfAdmin(user);
      }
    }

    // Check if the user is an admin (based on custom claims or UID)
    async function checkIfAdmin(user) {
      if (user.uid === "admin-uid") {  // Replace with actual admin UID or check via Firebase Custom Claims
        document.getElementById('moderation-section').style.display = 'block';
        loadModeration();
      }
    }

    // Load uploaded plugins from Firestore
    async function loadPlugins() {
      const pluginListDiv = document.getElementById('plugin-list');
      const pluginSnapshot = await getDocs(collection(db, 'plugins'));
      pluginListDiv.innerHTML = '';
      
      pluginSnapshot.forEach(doc => {
        const plugin = doc.data();
        const pluginItem = document.createElement('div');
        pluginItem.innerHTML = `
          <h3>${plugin.name}</h3>
          <a href="${plugin.url}" target="_blank">Download</a>
        `;
        pluginListDiv.appendChild(pluginItem);
      });
    }

    // Load plugins for moderation (admin view)
    async function loadModeration() {
      const moderationListDiv = document.getElementById('moderation-list');
      const moderationSnapshot = await getDocs(collection(db, 'plugins'));
      moderationListDiv.innerHTML = '';
      
      moderationSnapshot.forEach(doc => {
        const plugin = doc.data();
        const pluginItem = document.createElement('div');
        pluginItem.innerHTML = `
          <h3>${plugin.name}</h3>
          <button onclick="deletePlugin('${doc.id}')">Delete</button>
        `;
        moderationListDiv.appendChild(pluginItem);
      });
    }

    // Delete plugin (admin only)
    async function deletePlugin(pluginId) {
      await deleteDoc(doc(db, 'plugins', pluginId));
      loadModeration();
    }

    // Upload plugin to Firebase Storage and Firestore
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = document.getElementById('plugin-file').files[0];
      const pluginName = document.getElementById('plugin-name').value;
      
      if (file && pluginName) {
        // Upload the file to Firebase Storage
        const storageRef = ref(storage, 'plugins/' + file.name);
        await uploadBytes(storageRef, file);

        // Save plugin details to Firestore
        const fileURL = await getDownloadURL(storageRef);
        await addDoc(collection(db, 'plugins'), {
          name: pluginName,
          url: fileURL,
          uploadedBy: auth.currentUser.uid,
          timestamp: new Date()
        });

        loadPlugins();
      }
    });
  </script>
</head>
<body>
  <h1>RetroStudio Plugin Marketplace</h1>

  <!-- Login Section -->
  <div id="login-section">
    <button id="discord-login">Login with Discord</button>
  </div>

  <!-- Upload Plugin Section -->
  <div id="upload-section" style="display:none;">
    <h2>Upload Plugin</h2>
    <form id="upload-form">
      <input type="file" id="plugin-file" required />
      <input type="text" id="plugin-name" placeholder="Plugin Name" required />
      <button type="submit">Upload Plugin</button>
    </form>
  </div>

  <!-- Plugin List Section -->
  <div id="plugin-list-section" style="display:none;">
    <h2>Available Plugins</h2>
    <div id="plugin-list"></div>
  </div>

  <!-- Moderation Section (Admin Only) -->
  <div id="moderation-section" style="display:none;">
    <h2>Moderation</h2>
    <div id="moderation-list"></div>
  </div>
</body>
</html>
